!function(window){var errmsg={0:"成功",1:"错误的消息内容",2:"错误的参数",3:"IP地址不可达",4:"未初始化",5:"证书未加载",6:"服务不支持",7:"错误的域",8:"错误的类型",9:"错误的订阅类型",256:"其他错误",272:"消息发送超时",273:"消息处理异常",512:"SOCOKE错误",513:"连接为空",514:"连接超时",515:"连接中断",768:"Json错误",65535:"未知错误",28672:"未指定错误",28673:"错误的客户端ID",28674:"客户端未注册",28675:"服务器拒绝",28676:"用户数限制",28677:"客户端已注册",28678:"无效的对方ID",28679:"数据内容过大",28680:"数据内容过大",28681:"call_id字段为空",28682:"新证书和原证书不匹配",32768:"证书内容错误",32769:"无效的证书编号",32770:"证书连接地址格式错误",32771:"连接地址无权限",32772:"订阅类型格式错误",32773:"订阅类型无权限",32774:"通知类型格式错误",32775:"通知类型无权限",32776:"证书有效期格式错误",32777:"证书不在有效期",32778:"发送类型格式错误",32779:"发送类型无权限"},socket=null,timer=null,core_version="1.0",_WebSocket=window.WebSocket||window.WebKitWebSocket||window.MozWebSocket,_ws=window.ws,_Guid="",_sessionId="",_certificate={},_subscribe="",_register={},_resume={},_update={},_heart={},_sub={},_notify={},_info={},_handlers={},ws=function(opt){return new ws.fn.init(opt)};ws.fn=ws.prototype={ws:core_version,constructor:ws,_data:{},init:function(opt){var $wsUrl=opt.ip,$ip=$wsUrl.split(":")[0],$port=$wsUrl.split(":")[1]||"8080",handlers=_handlers,foo;switch(opt.variety){case"sub":ws.variety="订阅";ws.certificate=_certificate=opt.certificate;ws.subscribe=_subscribe=opt.subscribe;break;case"resume":ws.variety="重连";ws.certificate=_certificate=opt.certificate;break;case"update":ws.variety="更新";ws.certificate=_certificate=opt.certificate;break;case"notify":ws.variety="通知";ws.certificate=_certificate=opt.certificate;ws._notify=_notify=opt.content;ws._type=opt.notify;break;case"info":ws.variety="定向发送";ws.certificate=_certificate=opt.certificate;ws._info=_info=opt.content;ws._type=opt.send;ws._to=opt.to;break;default:console.error("请输入已有的api，如sub、resume、update、notify、info");break}if(_WebSocket){socket=new _WebSocket("ws://"+$ip+":"+$port);socket.onopen=function(res){_Guid=ws.fn.guid();ws.fn._Guid=_Guid;if(ws.variety=="订阅"){ws.regSend()}else{if(ws.variety=="重连"){ws.resume()}else{if(ws.variety=="通知"){ws.regSend()}else{if(ws.variety=="定向发送"){ws.regSend()}}}}if(handlers["open"]){foo=handlers["open"];foo()}};socket.onmessage=function(res){ws.fn._data=typeof res.data==="string"?JSON.parse(res.data):res.data;if(ws.fn._data.info.result&&ws.fn._data.info.result!=0){var result=ws.fn._data.info.result;console.error(errmsg[result])}if(ws.fn._data.method=="REGISTER"&&ws.fn._data.type=="register_resp"){_sessionId=ws.fn._data.info.session_id;ws.sessionId=_sessionId;if(ws.variety=="通知"){ws.notify()}else{if(ws.variety=="定向发送"){ws.info()}else{ws.subSend()}}ws.fn.heartBeat();if(handlers["register"]){foo=handlers["register"];foo()}}else{if(ws.fn._data.method=="REGISTER"&&ws.fn._data.type=="heart_beat"){if(handlers["heart_beat"]){foo=handlers["heart_beat"];foo()}}else{if(ws.fn._data.method=="REGISTER"&&ws.fn._data.type=="resume_resp"){if(handlers["resume"]){foo=handlers["resume"];foo()}}else{if(ws.fn._data.method=="REGISTER"&&ws.fn._data.type=="update_cer_resp"){if(handlers["update"]){foo=handlers["update"];foo()}}else{if(ws.fn._data.method=="REGISTER"&&ws.fn._data.type=="subscribe_resp"){if(handlers["subscribe"]){foo=handlers["subscribe"];foo()}}else{if(handlers["message"]){foo=handlers["message"];foo(ws.fn._data.info)}}}}}}};socket.onclose=function(res){if(handlers["close"]){foo=handlers["close"];foo()}};socket.onerror=function(res){if(handlers["error"]){foo=handlers["error"];foo()}}}else{alert("你的浏览器不支持WebSocket，请尝试其他浏览器")}},send:function(req){if(!socket||socket.readyState!=1){console.error("连接已断开，请重新连接")}else{if(socket.bufferedAmount==0){ws.fn.isJson(req)&&socket.send(JSON.stringify(req))}else{console.info("正在发送消息，请等候再发送!")}}},close:function(res){if(socket.readyState==1){socket.close()}},guid:function(){function S4(){return(((1+Math.random())*65536)|0).toString(16).substring(1)}return(S4()+S4()+"-"+S4()+"-"+S4()+"-"+S4()+"-"+S4()+S4()+S4())},isJson:function(obj){var isjson=typeof(obj)=="object"&&Object.prototype.toString.call(obj).toLowerCase()=="[object object]"&&!obj.length;return isjson},heartBeat:function(){_heart={"method":"INFO","from":_sessionId,"type":"heart_beat","call_id":_Guid};timer=setInterval(function(){if(socket.readyState==1){ws.fn.send(_heart)}else{clearInterval(timer)}},15000)},};ws.fn.init.prototype=ws.fn;ws.extend=ws.fn.extend=function(){var src,copyIsArray,copy,name,options,clone,target=arguments[0]||{},i=1,length=arguments.length,deep=false;if(typeof target==="boolean"){deep=target;target=arguments[1]||{};i=2}if(typeof target!=="object"&&!ws.isFunction(target)){target={}}if(length===i){target=this;--i}for(;i<length;i++){if((options=arguments[i])!=null){for(name in options){src=target[name];copy=options[name];if(target===copy){continue}if(deep&&copy&&(ws.isPlainObject(copy)||(copyIsArray=ws.isArray(copy)))){if(copyIsArray){copyIsArray=false;clone=src&&ws.isArray(src)?src:[]}else{clone=src&&ws.isPlainObject(src)?src:{}}target[name]=ws.extend(deep,clone,copy)}else{if(copy!==undefined){target[name]=copy}}}}}return target};ws.extend({isFunction:function(obj){return ws.variety(obj)==="function"
},type:function(obj){if(obj==null){return String(obj)}return typeof obj==="object"||typeof obj==="function"?class2type[core_toString.call(obj)]||"object":typeof obj},isArray:Array.isArray||function(obj){return jQuery.type(obj)==="array"},isPlainObject:function(obj){if(!obj||jQuery.type(obj)!=="object"||obj.nodeType||jQuery.isWindow(obj)){return false}try{if(obj.constructor&&!core_hasOwn.call(obj,"constructor")&&!core_hasOwn.call(obj.constructor.prototype,"isPrototypeOf")){return false}}catch(e){return false}var key;for(key in obj){}return key===undefined||core_hasOwn.call(obj,key)},});ws.extend({on:function(type,callBack){_handlers[type]=callBack},off:function(type,callBack){delete _handlers[type];callBack()},regSend:function(){var cert;ws.certificate=arguments[0]||ws.certificate;try{if(typeof ws.certificate=="object"){cert=ws.certificate}else{cert=JSON.parse(ws.certificate)}_register={"method":"REGISTER","type":"register_req","call_id":_Guid,"info":{"certificate":JSON.stringify(cert)}};ws.fn.send(_register)}catch(err){console.error("请输入符合json格式或json字符串格式的数字证书")}},resume:function(){var cert;ws.certificate=arguments[0]||ws.certificate;try{if(typeof ws.certificate=="object"){cert=ws.certificate}else{cert=JSON.parse(ws.certificate)}_resume={"method":"REGISTER","type":"resume_req","call_id":_Guid,"info":{"certificate":JSON.stringify(cert)}};ws.fn.send(_resume)}catch(err){console.error("请输入符合json格式或json字符串格式的数字证书")}},update:function(new_cert){var cert;ws.certificate=arguments[0]||new_cert;try{if(typeof ws.certificate=="object"){cert=ws.certificate}else{cert=JSON.parse(ws.certificate)}_update={"method":"REGISTER","type":"update_cer_req","call_id":_Guid,"info":{"certificate":JSON.stringify(cert)}};ws.fn.send(_update)}catch(err){console.error("请输入符合json格式或json字符串格式的数字证书")}},subSend:function(){var subtxt=arguments[0]||ws.subscribe,subArray=subtxt.split(";");var flag=true;for(var i=subArray.length-1;i>=0;i--){var new_subArray=subArray[i].split("@");if(new_subArray.length!=3){console.error("请输入正确的订阅信息");flag=false;break}}if(flag){_sub={"method":"REGISTER","type":"subscribe_req","from":_sessionId,"call_id":_Guid,"info":{"subscribe":subtxt}};ws.fn.send(_sub)}},notify:function(){var cont=arguments[0]||ws._notify,t=arguments[1]||ws._type;if(!ws.fn.isJson(cont)){return console.error("请输入符合json格式或json字符串格式的数字证书")}var not={"method":"NOTIFY","type":t,"from":_sessionId,"call_id":_Guid,"info":cont};ws.fn.send(not)},info:function(){var cont=arguments[0]||ws._info,t=arguments[1]||ws._type,to=arguments[2]||ws._to;if(!ws.fn.isJson(cont)){return console.error("请输入符合json格式或json字符串格式的数字证书")}var inf={"method":"INFO","type":t,"from":_sessionId,"to":to,"call_id":_Guid,"info":cont};ws.fn.send(inf)},open:function(ip){var $wsUrl=opt.ip,$ip=$wsUrl.split(":")[0],$port=$wsUrl.split(":")[1]||"8080";if(socket==null||socket.readyState==3){socket=new _WebSocket("ws://"+$ip+":"+$port)}else{console.error("请先关闭之前连接")}},close:function(res){if(socket.readyState==1){socket.close()}console.info("您已断开连接")},});window.ws=ws;if(typeof define==="function"&&define.amd&&define.amd.ws){define("ws",[],function(){return ws})}}(window);